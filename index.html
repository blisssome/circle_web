<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Double Back Tap Detector</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            max-width: 400px;
            width: 90%;
        }

        h1 {
            margin-bottom: 1.5rem;
            font-size: 2rem;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .status {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
        }

        .status.listening {
            background: rgba(76, 175, 80, 0.3);
            border: 2px solid #4CAF50;
        }

        .status.detected {
            background: rgba(255, 193, 7, 0.3);
            border: 2px solid #FFC107;
            animation: pulse 0.5s ease-in-out;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        button {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border: none;
            color: white;
            padding: 12px 24px;
            font-size: 1rem;
            border-radius: 25px;
            cursor: pointer;
            margin: 0.5rem;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: 600;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 1rem 0;
            text-align: left;
        }

        .metric {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.8rem;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .metric-label {
            font-weight: bold;
            color: #4ecdc4;
        }

        .tap-count {
            font-size: 3rem;
            font-weight: bold;
            margin: 1rem 0;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .instructions {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 10px;
            margin-top: 1rem;
            font-size: 0.9rem;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Double Back Tap Detector</h1>
        
        <div id="status" class="status">
            Click "Start Detection" to begin
        </div>

        <div class="tap-count" id="tapCount">0</div>
        <div style="font-size: 0.9rem; margin-bottom: 1rem;">Double Taps Detected</div>

        <div class="metrics">
            <div class="metric">
                <div class="metric-label">Acceleration X:</div>
                <div id="accelX">0.00</div>
            </div>
            <div class="metric">
                <div class="metric-label">Acceleration Y:</div>
                <div id="accelY">0.00</div>
            </div>
            <div class="metric">
                <div class="metric-label">Acceleration Z:</div>
                <div id="accelZ">0.00</div>
            </div>
            <div class="metric">
                <div class="metric-label">Magnitude:</div>
                <div id="magnitude">0.00</div>
            </div>
        </div>

        <button id="startBtn" onclick="startDetection()">Start Detection</button>
        <button id="stopBtn" onclick="stopDetection()" disabled>Stop Detection</button>
        <button onclick="resetCount()">Reset Count</button>

        <div class="instructions">
            <strong>Instructions:</strong><br>
            1. Hold your phone firmly<br>
            2. Double tap on the back of your phone<br>
            3. The detector will recognize the pattern
        </div>
    </div>

    <script>
        class DoubleTapDetector {
            constructor() {
                this.isListening = false;
                this.accelerationBuffer = [];
                this.tapCount = 0;
                this.lastTapTime = 0;
                
                // Detection parameters
                this.bufferSize = 100;
                this.tapThreshold = 9; // m/sÂ²
                this.doubleTapWindow = 300; // milliseconds
                this.cooldownPeriod = 300; // milliseconds
                this.minTapDuration = 30; // milliseconds
                this.maxTapDuration = 200; // milliseconds
                
                // Rate limiter
                this.lastDetectionTime = 0;
                this.rateLimitDelay = 500; // 1 second
                
                this.updateElements();
            }

            startListening() {
                if ('DeviceMotionEvent' in window) {
                    // Request permission for iOS 13+
                    if (typeof DeviceMotionEvent.requestPermission === 'function') {
                        DeviceMotionEvent.requestPermission()
                            .then(response => {
                                if (response === 'granted') {
                                    this.initializeListener();
                                } else {
                                    this.showStatus('Permission denied for motion sensors', false);
                                }
                            })
                            .catch(error => {
                                this.showStatus('Error requesting permission', false);
                            });
                    } else {
                        // Non-iOS or older iOS
                        this.initializeListener();
                    }
                } else {
                    this.showStatus('Device motion not supported', false);
                }
            }

            initializeListener() {
                this.isListening = true;
                this.accelerationBuffer = [];
                this.showStatus('Listening for double taps...', true);
                
                window.addEventListener('devicemotion', this.handleMotion.bind(this));
                
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
            }

            stopListening() {
                this.isListening = false;
                window.removeEventListener('devicemotion', this.handleMotion.bind(this));
                this.showStatus('Detection stopped', false);
                
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
            }

            handleMotion(event) {
                if (!this.isListening) return;

                const acceleration = event.accelerationIncludingGravity;
                if (!acceleration) return;

                const x = acceleration.x || 0;
                const y = acceleration.y || 0;
                const z = acceleration.z || 0;
                
                // Calculate magnitude
                const magnitude = Math.sqrt(x*x + y*y + z*z);
                
                // Update UI
                this.updateAcceleration(x, y, z, magnitude);
                
                // Add to buffer
                const dataPoint = {
                    x, y, z, magnitude,
                    timestamp: Date.now()
                };
                
                this.accelerationBuffer.push(dataPoint);
                
                // Keep buffer size manageable
                if (this.accelerationBuffer.length > this.bufferSize) {
                    this.accelerationBuffer.shift();
                }
                
                // Detect taps
                this.detectDoubleTap();
            }

            detectDoubleTap() {
                if (this.accelerationBuffer.length < 10) return;
                
                const now = Date.now();
                const recentData = this.accelerationBuffer.filter(
                    point => now - point.timestamp < 1000
                );
                
                // Find significant acceleration spikes (potential taps)
                const spikes = this.findAccelerationSpikes(recentData);
                
                if (spikes.length >= 2) {
                    const [firstSpike, secondSpike] = spikes.slice(-2);
                    const timeDiff = secondSpike.timestamp - firstSpike.timestamp;
                    
                    // Check if spikes are within double tap window
                    if (timeDiff >= this.minTapDuration && 
                        timeDiff <= this.doubleTapWindow &&
                        this.shouldAllowDetection()) {
                        
                        this.onDoubleTapDetected();
                        // Clear buffer to prevent multiple detections
                        this.accelerationBuffer = [];
                    }
                }
            }

            findAccelerationSpikes(data) {
                const spikes = [];
                
                for (let i = 2; i < data.length - 2; i++) {
                    const current = data[i];
                    const prev = data[i - 1];
                    const next = data[i + 1];
                    
                    // Look for sudden increases in acceleration magnitude
                    const deltaFromPrev = current.magnitude - prev.magnitude;
                    const deltaToNext = current.magnitude - next.magnitude;
                    
                    if (deltaFromPrev > this.tapThreshold && 
                        deltaToNext > this.tapThreshold / 2 &&
                        current.magnitude > this.tapThreshold) {
                        
                        // Check if this spike is distinct from previous ones
                        const isDistinct = spikes.every(spike => 
                            Math.abs(current.timestamp - spike.timestamp) > this.minTapDuration
                        );
                        
                        if (isDistinct) {
                            spikes.push({
                                timestamp: current.timestamp,
                                magnitude: current.magnitude,
                                x: current.x,
                                y: current.y,
                                z: current.z
                            });
                        }
                    }
                }
                
                return spikes;
            }

            shouldAllowDetection() {
                const now = Date.now();
                if (now - this.lastDetectionTime > this.rateLimitDelay) {
                    this.lastDetectionTime = now;
                    return true;
                }
                return false;
            }

            onDoubleTapDetected() {
                this.tapCount++;
                this.updateTapCount();
                this.showStatus('Double tap detected! ðŸŽ‰', true, true);
                
                // Vibrate if supported
                if (navigator.vibrate) {
                    navigator.vibrate([100, 50, 100]);
                }
                
                // Reset status after 2 seconds
                setTimeout(() => {
                    if (this.isListening) {
                        this.showStatus('Listening for double taps...', true);
                    }
                }, 2000);
                
                console.log('Double tap detected!', this.tapCount);
            }

            showStatus(message, isActive, isDetected = false) {
                const statusEl = document.getElementById('status');
                statusEl.textContent = message;
                statusEl.className = 'status';
                
                if (isDetected) {
                    statusEl.classList.add('detected');
                } else if (isActive) {
                    statusEl.classList.add('listening');
                }
            }

            updateAcceleration(x, y, z, magnitude) {
                document.getElementById('accelX').textContent = x.toFixed(2);
                document.getElementById('accelY').textContent = y.toFixed(2);
                document.getElementById('accelZ').textContent = z.toFixed(2);
                document.getElementById('magnitude').textContent = magnitude.toFixed(2);
            }

            updateTapCount() {
                document.getElementById('tapCount').textContent = this.tapCount;
            }

            resetCount() {
                this.tapCount = 0;
                this.updateTapCount();
                console.log('Tap count reset');
            }

            updateElements() {
                this.updateTapCount();
            }
        }

        // Global detector instance
        const detector = new DoubleTapDetector();

        function startDetection() {
            detector.startListening();
        }

        function stopDetection() {
            detector.stopListening();
        }

        function resetCount() {
            detector.resetCount();
        }

        // Handle page visibility changes
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && detector.isListening) {
                // Optionally pause detection when page is hidden
                console.log('Page hidden - detection continues');
            }
        });

        // Initial setup message
        console.log('Double Back Tap Detector loaded. Click Start Detection to begin.');
    </script>
</body>
</html>